<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Edukasi Islami</title>
    <!-- 1. Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Memuat Google Font (Poppins) yang lebih ramah anak -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Menggunakan font Poppins sebagai default */
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Style untuk feedback modal */
        #feedback-modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        /* Style untuk tombol kembali */
        .back-button {
            /* Tailwind classes applied via @apply */
            @apply text-blue-500 hover:text-blue-700 transition-colors duration-200;
        }

        /* Style untuk tombol level */
        .level-button {
            /* Tailwind classes applied via @apply */
            @apply w-full bg-white hover:bg-gray-100 text-gray-800 font-semibold py-4 px-6 rounded-lg shadow-md border border-gray-200 transition-all duration-200 text-lg;
        }

        /* Style untuk modal dan loading */
        .modal {
            @apply hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300;
        }
        .modal-content {
            @apply bg-white rounded-2xl p-6 sm:p-8 shadow-2xl w-full max-w-md;
        }
        .modal.show {
            @apply block opacity-100; /* Diubah dari 'flex' ke 'block' agar 'hidden' berfungsi */
        }
        
        /* (BARU) Style untuk Game Mencocokkan (Memory Game) */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .memory-card {
            @apply bg-white rounded-lg shadow-md aspect-square flex items-center justify-center text-3xl font-bold cursor-pointer transition-transform duration-300;
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        .memory-card .card-face {
            @apply absolute w-full h-full rounded-lg flex items-center justify-center;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .card-front {
            @apply bg-indigo-400 text-white;
            transform: rotateY(0deg);
        }
        .card-back {
            @apply bg-indigo-100 text-indigo-800;
            transform: rotateY(180deg);
        }
        /* Style untuk kartu saat 'flipped' (terbuka) */
        .memory-card.flipped {
            transform: rotateY(180deg);
        }
        /* Style untuk kartu yang sudah 'matched' (cocok) */
        .memory-card.matched {
            transform: rotateY(180deg);
            @apply bg-green-200 text-green-800 cursor-not-allowed;
            opacity: 0.7;
        }
        .memory-card.matched .card-back {
            @apply bg-green-200 text-green-800;
        }

    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen flex items-center justify-center p-4">

    <!-- Kontainer Utama Game -->
    <div id="app" class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-6 sm:p-8 text-center overflow-hidden">
        <!-- Konten game akan dimuat di sini oleh JavaScript -->
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 scale-90">
        <div id="feedback-content" class="bg-white rounded-2xl p-8 text-center shadow-xl">
            <!-- Konten feedback (Benar/Salah) akan dimuat di sini -->
        </div>
    </div>


    <!-- Template untuk Modal Loading Gemini -->
    <!-- (DIHAPUS) -->

    <!-- Template untuk Modal Input Topik AI -->
    <!-- (DIHAPUS) -->

    <script>
        // --- 1. REFERENSI ELEMEN DOM ---
        const app = document.getElementById('app');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackContent = document.getElementById('feedback-content');
        // (DIHAPUS) Referensi modal AI
        const loadingModal = null; // Dihapus, set ke null
        const topicModal = null; // Dihapus, set ke null
        const topicForm = null; // Dihapus, set ke null
        const topicInput = null; // Dihapus, set ke null


        // --- 2. DATA GAME ---
        // (Data hijaiyahData, doaData, rukunData masih sama)
        // Data untuk mode Tebak Huruf Hijaiyah (LENGKAP)
        const hijaiyahData = [
            // Level 1: Alif - Ra (10)
            { letter: 'ÿß', name: 'Alif' },
            { letter: 'ÿ®', name: 'Ba' },
            { letter: 'ÿ™', name: 'Ta' },
            { letter: 'ÿ´', name: 'Tsa' },
            { letter: 'ÿ¨', name: 'Jim' },
            { letter: 'ÿ≠', name: 'Ha' },
            { letter: 'ÿÆ', name: 'Kha' },
            { letter: 'ÿØ', name: 'Dal' },
            { letter: 'ÿ∞', name: 'Dzal' },
            { letter: 'ÿ±', name: 'Ra' },
            // Level 2: Za - Ghain (9)
            { letter: 'ÿ≤', name: 'Za' },
            { letter: 'ÿ≥', name: 'Sin' },
            { letter: 'ÿ¥', name: 'Syin' },
            { letter: 'ÿµ', name: 'Shad' },
            { letter: 'ÿ∂', name: 'Dhad' },
            { letter: 'ÿ∑', name: 'Tha' },
            { letter: 'ÿ∏', name: 'Zha' },
            { letter: 'ÿπ', name: 'Ain' },
            { letter: 'ÿ∫', name: 'Ghain' },
            // Level 3: Fa - Ya (10)
            { letter: 'ŸÅ', name: 'Fa' },
            { letter: 'ŸÇ', name: 'Qaf' },
            { letter: 'ŸÉ', name: 'Kaf' },
            { letter: 'ŸÑ', name: 'Lam' },
            { letter: 'ŸÖ', name: 'Mim' },
            { letter: 'ŸÜ', name: 'Nun' },
            { letter: 'Ÿà', name: 'Waw' },
            { letter: 'Ÿá', name: 'Ha (bulat)' },
            { letter: 'ÿ°', name: 'Hamzah' },
            { letter: 'Ÿä', name: 'Ya' }
        ];

        // Data untuk mode Hafalan Doa Harian (DITAMBAH)
        const doaData = [
            { arti: "Doa Sebelum Makan", doaText: "ÿßŸÑŸÑŸëŸéŸáŸèŸÖŸëŸé ÿ®Ÿéÿßÿ±ŸêŸÉŸí ŸÑŸéŸÜŸéÿß ŸÅŸêŸäŸÖŸéÿß ÿ±Ÿéÿ≤ŸéŸÇŸíÿ™ŸéŸÜŸéÿß ŸàŸéŸÇŸêŸÜŸéÿß ÿπŸéÿ∞Ÿéÿßÿ®Ÿé ÿßŸÑŸÜŸëŸéAR", roman: "Allahumma barik lana fima razaqtana waqina adzabannar" },
            { arti: "Doa Sebelum Tidur", doaText: "ÿ®Ÿêÿßÿ≥ŸíŸÖŸêŸÉŸé ÿßŸÑŸÑŸëŸéŸáŸèŸÖŸëŸé ÿ£Ÿéÿ≠ŸíŸäŸéÿß ŸàŸéÿ£ŸéŸÖŸèŸàÿ™Ÿè", roman: "Bismika Allahumma ahya wa amut" },
            { arti: "Doa Masuk Kamar Mandi", doaText: "ÿßŸÑŸÑŸëŸéŸáŸèŸÖŸëŸé ÿ•ŸêŸÜŸëŸêŸä ÿ£ŸéÿπŸèŸàÿ∞Ÿè ÿ®ŸêŸÉŸé ŸÖŸêŸÜŸé ÿßŸÑŸíÿÆŸèÿ®Ÿèÿ´Ÿê ŸàŸéÿßŸÑŸíÿÆŸéÿ®Ÿéÿßÿ¶Ÿêÿ´Ÿê", roman: "Allahumma inni a'udzubika minal khubutsi wal khabaits" },
            { arti: "Doa Untuk Orang Tua", doaText: "ÿ±Ÿéÿ®ŸëŸê ÿßÿ∫ŸíŸÅŸêÿ±Ÿí ŸÑŸêŸä ŸàŸéŸÑŸêŸàŸéÿßŸÑŸêÿØŸéŸäŸëŸé ŸàŸéÿßÿ±Ÿíÿ≠ŸéŸÖŸíŸáŸèŸÖŸéÿß ŸÉŸéŸÖŸéÿß ÿ±Ÿéÿ®ŸíŸäŸéÿßŸÜŸêŸä ÿµŸéÿ∫ŸêŸäÿ±Ÿãÿß", roman: "Rabbighfir li, wa li walidayya, warham huma kama rabbayani saghira" },
            { arti: "Doa Sebelum Belajar", doaText: "ÿ±Ÿéÿ®ŸëŸê ÿ≤ŸêÿØŸíŸÜŸêŸä ÿπŸêŸÑŸíŸÖŸãÿß ŸàŸéÿßÿ±Ÿíÿ≤ŸèŸÇŸíŸÜŸêŸä ŸÅŸéŸáŸíŸÖŸãÿß", roman: "Rabbi zidni 'ilman warzuqni fahman" },
            { arti: "Doa Keluar Rumah", doaText: "ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸëŸéŸáŸê ÿ™ŸéŸàŸéŸÉŸëŸéLŸÑŸíÿ™Ÿè ÿπŸéŸÑŸéŸâ ÿßŸÑŸÑŸëŸéŸáŸêÿå ŸÑŸéÿß ÿ≠ŸéŸàŸíŸÑŸé ŸàŸéŸÑŸéÿß ŸÇŸèŸàŸëŸéÿ©Ÿé ÿ•ŸêŸÑŸëŸéÿß ÿ®ŸêÿßŸÑŸÑŸëŸéŸáŸê", roman: "Bismillahi tawakkaltu 'alallah, la haula wa la quwwata illa billah" }
        ];

        // Data untuk Kuis Cerdas Islami
        const rukunData = [
            { question: "Ada berapa Rukun Iman?", options: ["6", "5", "10"], answer: "6" },
            { question: "Ada berapa Rukun Islam?", options: ["5", "6", "3"], answer: "5" },
            { question: "Rukun Iman yang pertama adalah...", options: ["Iman kepada Allah", "Iman kepada Malaikat", "Iman kepada Rasul"], answer: "Iman kepada Allah" },
            { question: "Rukun Islam yang pertama adalah...", options: ["Mengucap Syahadat", "Shalat", "Puasa"], answer: "Mengucap Syahadat" },
            { question: "Rukun Islam yang ketiga adalah...", options: ["Zakat", "Puasa", "Haji"], answer: "Zakat" },
            { question: "Iman kepada Hari Akhir adalah Rukun Iman ke...", options: ["5", "6", "4"], answer: "5" },
            { question: "Shalat adalah Rukun Islam ke...", options: ["2", "1", "3"], answer: "2" },
            { question: "Percaya pada Kitab-kitab Allah adalah Rukun Iman ke...", options: ["3", "4", "2"], answer: "3" }
        ];


        // --- 3. GAME STATE (KONDISI GAME) ---
        let currentMode = null; // 'hijaiyah', 'doa', 'rukun', 'memory'
        let currentLevel = null; // 1, 2, or 3 (for hijaiyah)
        let score = 0;
        let totalCoins = 0; 
        let questions = [];
        let currentQuestionIndex = 0;
        
        // (BARU) State untuk Memory Game
        let memoryCards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let memoryMoves = 0;
        let lockBoard = false;


        // --- 4. FUNGSI UTAMA GAME ---

        // (speak, shuffleArray, ... masih sama)
        /**
         * Fungsi untuk mengucapkan teks menggunakan Web Speech API
         * @param {string} text - Teks yang akan diucapkan
         * @param {string} lang - Kode bahasa (e.g., 'id-ID', 'ar-SA')
         */
        function speak(text, lang = 'id-ID') {
            try {
                if (!('speechSynthesis' in window)) {
                    console.warn("Speech synthesis tidak didukung di browser ini.");
                    return;
                }
                // Hentikan suara sebelumnya jika ada
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = (lang === 'ar-SA') ? 0.7 : 0.9; // Perlambat suara Arab
                window.speechSynthesis.speak(utterance);
            } catch (error) {
                console.error("Gagal menjalankan speech synthesis:", error);
            }
        }

        /**
         * Fungsi untuk mengacak urutan array (Fisher-Yates shuffle)
         * @param {Array} array - Array yang akan diacak
         */
        function shuffleArray(array) {
            let newArray = [...array]; // Salin array
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        /**
         * Menampilkan Halaman Utama (Menu Pilihan Mode) - (DIPERBARUI)
         */
        function renderMainMenu() {
            currentMode = null; // Reset mode
            app.innerHTML = `
                <!-- Tampilan Koin -->
                <div class="absolute top-4 right-4 bg-yellow-400 text-yellow-900 font-bold px-4 py-2 rounded-full shadow-lg">
                    üí∞ ${totalCoins} Koin
                </div>

                <h1 class="text-3xl font-bold text-indigo-700 mb-6 mt-12 sm:mt-6">Ayo Belajar Sambil Bermain!</h1>
                <p class="text-gray-600 mb-8">Pilih permainan yang kamu suka:</p>
                <div class="space-y-4">
                    <button onclick="renderHijaiyahMenu()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform duration-200 text-lg">
                        Tebak Huruf Hijaiyah
                    </button>
                    <button onclick="startGame('doa')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform duration-200 text-lg">
                        Hafalan Doa Harian
                    </button>
                    <button onclick="startGame('rukun')" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform duration-200 text-lg">
                        Kuis Cerdas Islami
                    </button>
                    <!-- (BARU) Tombol Game Mencocokkan -->
                    <button onclick="startGame('memory')" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform duration-200 text-lg">
                        Game Mencocokkan
                    </button>
                    <!-- (DIHAPUS) Tombol Kuis AI -->
                </div>
            `;
        }

        // (renderHijaiyahMenu masih sama)
        function renderHijaiyahMenu() {
            app.innerHTML = `
                <h2 class="text-2xl font-bold text-green-700 mb-6">Pilih Level Hijaiyah</h2>
                <div class="space-y-3">
                    <button onclick="startGame('hijaiyah', 1)" class="level-button">
                        Level 1 (Alif - Ra)
                    </button>
                    <button onclick="startGame('hijaiyah', 2)" class="level-button">
                        Level 2 (Za - Ghain)
                    </button>
                    <button onclick="startGame('hijaiyah', 3)" class="level-button">
                        Level 3 (Fa - Ya)
                    </button>
                </div>
                <button onclick="renderMainMenu()" class="mt-8 text-blue-600 hover:text-blue-800 transition-colors duration-200">&larr; Kembali ke Menu</button>
            `;
        }

        /**
         * Memulai permainan - (DIPERBARUI)
         * @param {string} mode - 'hijaiyah', 'doa', 'rukun', 'memory'
         * @param {number} [level] - 1, 2, or 3 (khusus hijaiyah)
         */
        function startGame(mode, level = null) {
            currentMode = mode;
            currentLevel = level;
            score = 0;
            currentQuestionIndex = 0;
            questions = [];

            if (mode === 'hijaiyah') {
                let sourceData;
                if (level === 1) sourceData = hijaiyahData.slice(0, 10);
                else if (level === 2) sourceData = hijaiyahData.slice(10, 19);
                else sourceData = hijaiyahData.slice(19);
                
                questions = shuffleArray(sourceData).slice(0, 10); // Ambil 10 pertanyaan acak
                renderQuestion(); // Mulai kuis
                
            } else if (mode === 'doa') {
                questions = shuffleArray(doaData).slice(0, 5); // Ambil 5 pertanyaan acak
                renderQuestion(); // Mulai kuis

            } else if (mode === 'rukun') { // (DIHAPUS) 'ai-quiz'
                // (DIHAPUS) Kondisi 'ai-quiz'
                if (mode === 'rukun') {
                    questions = shuffleArray(rukunData).slice(0, 5); // Ambil 5 pertanyaan acak
                }
                renderQuestion(); // Mulai kuis
            
            } else if (mode === 'memory') {
                // (BARU) Logika untuk memulai Game Mencocokkan
                // Ambil 6 pasangan acak dari level 1 Hijaiyah untuk 12 kartu
                let pairs = shuffleArray(hijaiyahData.slice(0, 10)).slice(0, 6);
                
                // Buat kartu (1 letter, 1 name per pair)
                memoryCards = [];
                pairs.forEach(pair => {
                    memoryCards.push({ type: 'letter', value: pair.name, content: pair.letter, id: pair.name + '_l' });
                    memoryCards.push({ type: 'name', value: pair.name, content: pair.name, id: pair.name + '_n' });
                });
                
                memoryCards = shuffleArray(memoryCards);
                matchedPairs = 0;
                memoryMoves = 0;
                flippedCards = [];
                lockBoard = false;
                
                renderMemoryBoard(); // Render papan game
            }
        }

        /**
         * Router untuk menampilkan pertanyaan
         * Memanggil fungsi render yang sesuai berdasarkan mode
         */
        function renderQuestion() {
            if (currentQuestionIndex >= questions.length) {
                renderScoreScreen();
                return;
            }

            const question = questions[currentQuestionIndex];

            if (currentMode === 'hijaiyah') {
                renderHijaiyahQuestion(question);
            } else if (currentMode === 'doa') {
                renderDoaQuestion(question);
            } else if (currentMode === 'rukun') { // (DIHAPUS) 'ai-quiz'
                renderRukunQuestion(question);
            }
        }

        // (renderHijaiyahQuestion, renderDoaQuestion, renderRukunQuestion masih sama)
        /**
         * Menampilkan pertanyaan Hijaiyah
         */
        function renderHijaiyahQuestion(question) {
            const correctAnswer = question.name;
            
            // Buat 2 pilihan salah
            let wrongOptions = hijaiyahData
                .filter(item => item.name !== correctAnswer) // Filter jawaban benar
                .map(item => item.name); // Ambil namanya saja
            
            wrongOptions = shuffleArray(wrongOptions).slice(0, 2); // Ambil 2 acak
            
            // Gabung dan acak semua pilihan
            const options = shuffleArray([correctAnswer, ...wrongOptions]);

            app.innerHTML = `
                <p class="text-sm text-gray-500 mb-2">Pertanyaan ${currentQuestionIndex + 1} / ${questions.length}</p>
                
                <!-- Huruf Hijaiyah -->
                <div class="bg-green-100 rounded-xl p-6 mb-8 flex justify-center items-center" style="min-height: 12rem;">
                    <h2 class="text-8xl font-bold text-green-800" style="font-family: 'Times New Roman', Times, serif;">${question.letter}</h2>
                </div>

                <!-- Tombol Suara -->
                <button onclick="speak('${question.name}', 'id-ID')" class="mb-6 bg-blue-100 text-blue-700 px-4 py-2 rounded-full hover:bg-blue-200 transition">
                    üîä Dengarkan Nama
                </button>

                <!-- Tombol Pilihan -->
                <div class="space-y-3">
                    ${options.map(option => `
                        <button onclick="checkAnswer('${option.replace(/'/g, "\\'")}', '${correctAnswer.replace(/'/g, "\\'")}')" class="w-full bg-white hover:bg-gray-100 text-gray-800 font-semibold py-4 px-6 rounded-lg shadow-md border border-gray-200 transition-all duration-200 text-lg">
                            ${option}
                        </button>
                    `).join('')}
                </div>
            `;
        }
        
        /**
         * Menampilkan pertanyaan Hafalan Doa
         */
        function renderDoaQuestion(question) {
            const correctAnswer = question.arti;
            
            // Buat 2 pilihan salah
            let wrongOptions = doaData
                .filter(item => item.arti !== correctAnswer)
                .map(item => item.arti);
                
            wrongOptions = shuffleArray(wrongOptions).slice(0, 2);
            
            // Gabung dan acak semua pilihan
            const options = shuffleArray([correctAnswer, ...wrongOptions]);

            app.innerHTML = `
                <p class="text-sm text-gray-500 mb-2">Pertanyaan ${currentQuestionIndex + 1} / ${questions.length}</p>
                
                <!-- Teks Doa -->
                <div class="bg-blue-100 rounded-xl p-6 mb-4 min-h-[10rem] flex flex-col justify-center items-center">
                    <h2 class="text-3xl font-bold text-blue-800 text-right leading-relaxed" style="font-family: 'Times New Roman', Times, serif;">${question.doaText}</h2>
                    <p class="text-blue-600 text-sm mt-2 italic">${question.roman}</p>
                </div>

                <!-- Tombol Suara -->
                <button onclick="speak('${question.doaText}', 'ar-SA')" class="mb-6 bg-green-100 text-green-700 px-4 py-2 rounded-full hover:bg-green-200 transition">
                    üîä Dengarkan Doa
                </button>

                <p class="text-lg text-gray-700 mb-4">Apa arti dari doa di atas?</p>

                <!-- Tombol Pilihan -->
                <div class="space-y-3">
                    ${options.map(option => `
                        <button onclick="checkAnswer('${option.replace(/'/g, "\\'")}', '${correctAnswer.replace(/'/g, "\\'")}')" class="w-full bg-white hover:bg-gray-100 text-gray-800 font-semibold py-4 px-6 rounded-lg shadow-md border border-gray-200 transition-all duration-200 text-lg">
                            ${option}
                        </button>
                    `).join('')}
                </div>
            `;
        }
        
        /**
         * Menampilkan pertanyaan Kuis (Rukun / AI)
         */
        function renderRukunQuestion(question) {
            const correctAnswer = question.answer;
            
            // Pilihan sudah ada di data, kita tinggal acak
            const options = shuffleArray(question.options); 

            // (DIHAPUS) Logika judul dinamis
            const title = 'Kuis Cerdas Islami';

            app.innerHTML = `
                <p class="text-sm text-gray-500 mb-2">${title} (${currentQuestionIndex + 1} / ${questions.length})</p>
                
                <!-- Pertanyaan -->
                <div class="bg-purple-100 rounded-xl p-6 mb-8 min-h-[10rem] flex justify-center items-center">
                    <h2 class="text-2xl font-bold text-purple-800 text-center">${question.question}</h2>
                </div>

                <!-- Tombol Pilihan -->
                <div class="space-y-3">
                    ${options.map(option => `
                        <button onclick="checkAnswer('${option.replace(/'/g, "\\'")}', '${correctAnswer.replace(/'/g, "\\'")}')" class="w-full bg-white hover:bg-gray-100 text-gray-800 font-semibold py-4 px-6 rounded-lg shadow-md border border-gray-200 transition-all duration-200 text-lg">
                            ${option}
                        </button>
                    `).join('')}
                </div>
            `;
        }

        /**
         * (BARU) Menampilkan Papan Game Mencocokkan
         */
        function renderMemoryBoard() {
            app.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-orange-700">Game Mencocokkan</h2>
                    <p class="text-lg">Langkah: <span id="moves-count" class="font-bold">${memoryMoves}</span></p>
                </div>
                <div class="memory-grid mb-6">
                    ${memoryCards.map((card, index) => `
                        <div class="memory-card" data-index="${index}" data-id="${card.id}" data-value="${card.value}" data-type="${card.type}" onclick="flipCard(${index})">
                            <div class="card-face card-front">?</div>
                            <!-- (DIPERBARUI) Logika tampilan konten kartu -->
                            <div class="card-face card-back ${card.type === 'letter' ? 'text-6xl' : 'text-lg'}">
                                ${card.content}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <button onclick="renderMainMenu()" class="mt-4 text-blue-600 hover:text-blue-800 transition-colors duration-200">&larr; Kembali ke Menu</button>
            `;
        }

        /**
         * (BARU) Logika untuk membalik kartu
         * @param {number} index - Index kartu yang diklik
         */
        function flipCard(index) {
            if (lockBoard) return; // Papan terkunci, jangan lakukan apa-apa
            
            const cardElement = document.querySelector(`.memory-card[data-index="${index}"]`);
            
            // Jangan lakukan apa-apa jika kartu sudah terbalik atau sudah cocok
            if (cardElement.classList.contains('flipped') || cardElement.classList.contains('matched')) return;

            cardElement.classList.add('flipped');
            flippedCards.push(cardElement);

            // Jika ini kartu kedua yang dibalik
            if (flippedCards.length === 2) {
                memoryMoves++; // Tambah jumlah langkah
                document.getElementById('moves-count').textContent = memoryMoves;
                lockBoard = true; // Kunci papan
                checkForMatch();
            }
        }

        /**
         * (BARU) Logika untuk memeriksa pasangan kartu
         */
        function checkForMatch() {
            const [card1, card2] = flippedCards;
            const isMatch = card1.dataset.value === card2.dataset.value && card1.dataset.type !== card2.dataset.type;

            if (isMatch) {
                // Pasangan cocok!
                matchedPairs++;
                card1.classList.add('matched');
                card2.classList.add('matched');
                speak('MasyaAllah', 'id-ID');
                
                resetBoard();

                // Cek jika game selesai
                if (matchedPairs === memoryCards.length / 2) {
                    // Beri koin berdasarkan jumlah langkah (semakin sedikit semakin bagus)
                    // Misal: 100 koin - (langkah * 5)
                    let koinDidapat = Math.max(20, 100 - (memoryMoves * 5)); 
                    totalCoins += koinDidapat;
                    localStorage.setItem('islamicGameCoins', totalCoins.toString());
                    
                    setTimeout(() => {
                        renderMemoryScoreScreen(koinDidapat); // Tampilkan layar skor khusus memory
                    }, 1000);
                }
            } else {
                // Tidak cocok
                setTimeout(() => {
                    card1.classList.remove('flipped');
                    card2.classList.remove('flipped');
                    resetBoard();
                }, 1200); // Tunggu 1.2 detik sebelum dibalik
            }
        }

        /**
         * (BARU) Reset papan setelah 2 kartu dibuka
         */
        function resetBoard() {
            flippedCards = [];
            lockBoard = false;
        }


        /**
         * Memeriksa jawaban (Untuk mode Kuis)
         */
        function checkAnswer(selectedOption, correctAnswer) {
            // ... (Fungsi checkAnswer masih sama)
            // Nonaktifkan semua tombol untuk mencegah klik ganda
            const buttons = document.querySelectorAll('#app button');
            buttons.forEach(button => button.disabled = true);

            const isCorrect = (selectedOption === correctAnswer);

            if (isCorrect) {
                score++;
                // Tambah koin dan simpan
                let koinDidapat = 10; // Koin per jawaban benar
                totalCoins += koinDidapat;
                localStorage.setItem('islamicGameCoins', totalCoins.toString());
                
                showFeedback(true);
            } else {
                showFeedback(false);
            }

            // Tampilkan pertanyaan berikutnya setelah feedback selesai
            setTimeout(() => {
                currentQuestionIndex++;
                renderQuestion(); // Ini akan menampilkan pertanyaan berikutnya atau layar skor
            }, 1800);
        }

        // (showFeedback masih sama)
        /**
         * Menampilkan modal feedback (Benar/Salah)
         * @param {boolean} isCorrect - Status jawaban
         * @param {string} [customMessage] - Pesan kustom (untuk AI error)
         */
        function showFeedback(isCorrect, customMessage = null) {
            if (customMessage) {
                // Feedback khusus (misal: error AI)
                feedbackContent.innerHTML = `
                    <div class="text-7xl mb-4">üò¢</div>
                    <h3 class="text-3xl font-bold text-red-600">Oops, Gagal!</h3>
                    <p class="text-lg text-gray-700">${customMessage}</p>
                `;
                feedbackContent.parentElement.className = "bg-white rounded-2xl p-8 text-center shadow-xl border-4 border-red-400";
                speak('Oops, Gagal!', 'id-ID');
            }
            else if (isCorrect) {
                feedbackContent.innerHTML = `
                    <div class="text-7xl mb-4">‚≠ê</div>
                    <h3 class="text-3xl font-bold text-green-600">MasyaAllah!</h3>
                    <p class="text-lg text-gray-700">Jawabanmu Benar!</p>
                `;
                feedbackContent.parentElement.className = "bg-white rounded-2xl p-8 text-center shadow-xl border-4 border-green-400";
                speak('MasyaAllah! Jawabanmu Benar!', 'id-ID');
            } else {
                feedbackContent.innerHTML = `
                    <div class="text-7xl mb-4">üò¢</div>
                    <h3 class="text-3xl font-bold text-red-600">Coba Lagi!</h3>
                    <p class="text-lg text-gray-700">Jangan menyerah, ya!</p>
                `;
                feedbackContent.parentElement.className = "bg-white rounded-2xl p-8 text-center shadow-xl border-4 border-red-400";
                speak('Ayo coba lagi', 'id-ID');
            }
            
            // Tampilkan modal
            feedbackModal.classList.remove('hidden');
            setTimeout(() => {
                feedbackModal.classList.remove('opacity-0', 'scale-90');
                feedbackModal.classList.add('opacity-100', 'scale-100');
            }, 10); // sedikit jeda untuk transisi

            // Sembunyikan modal setelah 1.5 detik
            setTimeout(() => {
                feedbackModal.classList.remove('opacity-100', 'scale-100');
                feedbackModal.classList.add('opacity-0', 'scale-90');
                setTimeout(() => {
                    feedbackModal.classList.add('hidden');
                }, 300); // tunggu transisi selesai
            }, 1500);
        }

        /**
         * Menampilkan Halaman Skor Akhir (Untuk mode Kuis)
         */
        function renderScoreScreen() {
            let percentage = (score / questions.length) * 100;
            let badge = '';
            let message = '';
            // let koinDidapat = score * 10; (Perhitungan koin sudah dilakukan di checkAnswer)

            if (percentage >= 80) {
                if (currentMode === 'hijaiyah') badge = 'Ahli Hijaiyah';
                if (currentMode === 'doa') badge = 'Juara Hafalan';
                if (currentMode === 'rukun') badge = 'Anak Sholeh/Sholehah'; // (DIHAPUS) 'ai-quiz'
                message = `Luar biasa! Kamu hebat!`;
            } else if (percentage >= 50) {
                message = `Bagus! Terus berlatih, ya!`;
            } else {
                message = `Jangan patah semangat, ayo coba lagi!`;
            }

            app.innerHTML = `
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">Permainan Selesai!</h2>
                <p class="text-lg text-gray-700 mb-6">${message}</p>
                
                <div class="bg-gray-100 rounded-xl p-6 mb-6">
                    <p class="text-lg">Skor Kamu:</p>
                    <p class="text-6xl font-bold text-indigo-600">${score} <span class="text-3xl text-gray-500">/ ${questions.length}</span></p>
                    <!-- Tampilan Total Koin -->
                    <p class="text-lg font-semibold text-yellow-700 mt-2">Total Koin Kamu: üí∞ ${totalCoins}</p>
                </div>
                
                ${badge ? `
                <div class="bg-yellow-100 border-2 border-yellow-300 rounded-xl p-4 mb-6">
                    <p class="text-2xl">üèÜ</p>
                    <p class="font-bold text-yellow-800">Selamat! Kamu mendapat badge:</p>
                    <p class="text-xl font-semibold text-yellow-900">${badge}</p>
                </div>
                ` : ''}

                <button onclick="renderMainMenu()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform duration-200 text-lg">
                    Main Lagi
                </button>
            `;
        }
        
        /**
         * (BARU) Menampilkan Halaman Skor Akhir (Untuk Game Mencocokkan)
         * @param {number} koinDidapat - Jumlah koin yang dimenangkan ronde ini
         */
        function renderMemoryScoreScreen(koinDidapat) {
            let badge = 'Pendeteksi Pasangan';
            let message = `Luar biasa! Kamu menyelesaikan game dalam ${memoryMoves} langkah!`;
            
            app.innerHTML = `
                <h2 class="text-2xl font-bold text-orange-700 mb-4">Permainan Selesai!</h2>
                <p class="text-lg text-gray-700 mb-6">${message}</p>
                
                <div class="bg-gray-100 rounded-xl p-6 mb-6">
                    <p class="text-lg">Jumlah Langkah:</p>
                    <p class="text-6xl font-bold text-orange-600">${memoryMoves}</p>
                    <p class="text-lg font-semibold text-yellow-700 mt-2">Total Koin Kamu: üí∞ ${totalCoins}</p>
                </div>
                
                <div class="bg-yellow-100 border-2 border-yellow-300 rounded-xl p-4 mb-6">
                    <p class="text-2xl">üèÜ</p>
                    <p class="font-bold text-yellow-800">Selamat! Kamu mendapat badge:</p>
                    <p class="text-xl font-semibold text-yellow-900">${badge}</p>
                </div>

                <button onclick="renderMainMenu()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform hover:scale-105 transition-transform duration-200 text-lg">
                    Main Lagi
                </button>
            `;
        }

        // --- 5. FUNGSI-FUNGSI GEMINI API ---

        // (DIHAPUS) Semua fungsi terkait Gemini API
        // openTopicModal, closeTopicModal, showLoading,
        // event listener, dan generateQuizWithGemini


        // --- 6. INISIALISASI ---
        window.onload = () => {
            // Muat koin dari localStorage
            totalCoins = parseInt(localStorage.getItem('islamicGameCoins') || '0');

            if (!('speechSynthesis' in window)) {
                console.warn("Browser kamu tidak mendukung fitur suara.");
            }
            renderMainMenu();
        };

    </script>
</body>
</html>
